<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>에듀 스마일 관리자 페이지</title>
        <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
        <link href="/css/styles.css" rel="stylesheet" />
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    </head>
    <body class="sb-nav-fixed">
        <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
            <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i class="fas fa-bars"></i></button>
            <!-- Navbar Brand-->
            <a class="navbar-brand ps-3" href="/admin">관리자 페이지</a>
            <!-- Sidebar Toggle-->

        </nav>
        <div id="layoutSidenav">
            <div id="layoutSidenav_nav">
                <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                    <div class="sb-sidenav-menu">
                        <div class="nav">
                            <div class="sb-sidenav-menu-heading">통계</div>
                            <a class="nav-link" href="/admin">
                                <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                                Dashboard
                            </a>

                            <div class="sb-sidenav-menu-heading">서비스 관리</div>
                            <a class="nav-link" href="/admin/memberManage">
                                <div class="sb-nav-link-icon"><i class="fas fa-table"></i></div>
                                권한 관리
                            </a>
                        </div>
                    </div>
                </nav>
            </div>
            <div id="layoutSidenav_content">
                <main>
                    <div class="container-fluid px-4">
                        <h1 class="mt-4">권한 관리</h1>
                        <ol class="breadcrumb mb-4">
                            <li class="breadcrumb-item active">사용자 권한 관리</li>
                        </ol>

                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="fas fa-table me-1"></i>
                                Member
                            </div>
                            <div class="card-body">
                                <table id="datatablesSimple">
                                    <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>로그인 ID</th>
                                        <th>이름</th>
                                        <th>전화 번호</th>
                                        <th>역할</th>
                                        <th>생성일</th>
                                        <th>수정일</th>
                                        <th>권한 변경</th>
                                    </tr>
                                    </thead>
                                    <tfoot>
                                    <tr>
                                        <th>ID</th>
                                        <th>로그인 ID</th>
                                        <th>이름</th>
                                        <th>전화 번호</th>
                                        <th>역할</th>
                                        <th>생성일</th>
                                        <th>수정일</th>
                                        <th>권한 변경</th>

                                    </tr>
                                    </tfoot>
                                    <tbody>
                                    {{#member}}
                                        <tr>
                                            <td>{{id}}</td>
                                            <td>{{loginId}}</td>
                                            <td>{{name}}</td>
                                            <td>{{phoneNumber}}</td>
                                            <td>{{role}}</td>
                                            <td>{{createdDate}}</td>
                                            <td>{{lastModifiedDate}}</td>
                                            <td>
                                                <button class="btn btn-primary role-btn"
                                                        onclick="openModal('{{id}}', '{{loginId}}', '{{name}}', '{{phoneNumber}}', '{{role}}', '{{createdDate}}', '{{lastModifiedDate}}')"
                                                        data-role="{{role}}">
                                                    수정
                                                </button>
                                            </td>
                                        </tr>
                                    {{/member}}

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </main>
                <div class="modal fade" id="memberModal" tabindex="-1" aria-labelledby="memberModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="memberModalLabel">회원 정보 수정</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="roleUpdateForm">
                                    <div class="mb-3">
                                        <label class="form-label">ID</label>
                                        <input type="text" class="form-control" id="modalMemberId" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">로그인 ID</label>
                                        <input type="text" class="form-control" id="modalLoginId" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">이름</label>
                                        <input type="text" class="form-control" id="modalName" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">전화 번호</label>
                                        <input type="text" class="form-control" id="modalPhoneNumber" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">역할</label>
                                        <select class="form-select" id="modalRole">
                                            <option value="teacher">teacher</option>
                                            <option value="ADMIN">ADMIN</option>
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                                <button type="button" class="btn btn-primary" onclick="updateRole()">저장</button>
                            </div>
                        </div>
                    </div>
                </div>

                <footer class="py-4 bg-light mt-auto">
                    <div class="container-fluid px-4">
                        <div class="d-flex align-items-center justify-content-between small">
                            <div class="text-muted">Copyright &copy; Edusmile 2025</div>
                            <div>
                            </div>
                        </div>
                    </div>
                </footer>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="/js/scripts.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script>
        <script src="/js/datatables-simple-demo.js"></script>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".role-btn").forEach(button => {
                    if (button.getAttribute("data-role") === "student") {
                        button.style.display = "none";  // student 역할이면 숨기기
                    }
                });
            });

            function openModal(id, loginId, name, phoneNumber, role, createdDate, lastModifiedDate) {
                document.getElementById("modalMemberId").value = id;
                document.getElementById("modalLoginId").value = loginId;
                document.getElementById("modalName").value = name;
                document.getElementById("modalPhoneNumber").value = phoneNumber;
                document.getElementById("modalRole").value = role;

                let roleSelect = document.getElementById("modalRole");
                for (let option of roleSelect.options) {
                    if (option.value === role) {
                        option.selected = true;
                        break;
                    }
                }
                // Bootstrap 모달 열기
                let memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
                memberModal.show();
            }

            function updateRole() {
                let memberId = document.getElementById("modalMemberId").value;
                let newRole = document.getElementById("modalRole").value;

                if (!confirm("정말 권한을 변경하시겠습니까?")) {
                    return;
                }

                fetch(`/admin/update-role`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        id: memberId,
                        role: newRole
                    })
                })
                        .then(response => {
                            if (response.ok) {
                                alert("✅ 역할이 성공적으로 변경되었습니다.");
                                location.reload(); // 변경 후 페이지 새로고침
                            } else {
                                alert("❌ 변경 실패. 다시 시도해주세요.");
                            }
                        })
                        .catch(error => {
                            console.error("Error updating role:", error);
                            alert("❌ 서버 오류 발생.");
                        });
            }
        </script>
    </body>
</html>
