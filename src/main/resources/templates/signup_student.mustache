<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>signup</title>
    <link rel="stylesheet" href="/css/signup_student.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/4.2.0/mustache.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
<!--
<form action="/user/signupsave" method="post" oninput="return validateForm()">

    {{#duplication}}
        <div class="alert alert-danger" role="alert">
            이미 존재하는 ID 입니다.
        </div>
    {{/duplication}}
    <div class="mb-3">
        <label for="ID 입력" class="form-label">회원 ID</label>
        <input type="text" class="form-control" id="LoginId" name="loginId" maxlength='30' required>
        <div id="idError" class="text-danger" style="display: none;">아이디는 6-12자의 영문, 숫자, 기호(-, _)만 사용 가능합니다.</div>
    </div>
    <div class="mb-3">
        <label for="비번입력" class="form-label">비밀번호</label>
        <input type="password" class="form-control" id="password" name="password" maxlength='30' required>
        <div id="passwordError" class="text-danger" style="display: none;">비밀번호는 6-15자의 영문, 숫자, 특수문자가 하나 이상 필요합니다.(숫자로 시작 불가)</div>
    </div>
    <div class="mb-3">
        <label for="이름입력" class="form-label">이름</label>
        <input type="text" class="form-control" id="name" name="name" maxlength='30' required>
        <div id="nameError" class="text-danger" style="display: none;">이름은 한글 또는 영어로만 입력 가능합니다.</div>
    </div>
    <div class="mb-3">
        <label for="전화번호" class="form-label">전화번호</label>
        <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" maxlength='13' required>
        <div id="phoneError" class="text-danger" style="display: none;">전화번호는 숫자와 (-) 만 입력 가능합니다.</div>
    </div>
    {{#not_exist_teacherCode}}
        <div class="alert alert-danger" role="alert">
            존재하지 않는 교사 코드입니다.
        </div>
    {{/not_exist_teacherCode}}
    <div class="mb-3">
        <label for="교사코드" class="form-label">교사 코드</label>
        <input type="text" class="form-control" id="teacherCode" name="teacherCode" maxlength='13' required>
    </div>


    <input type="hidden" id="role" name="role" value="student">


    <button type="submit" class="btn btn-primary">회원가입</button>
    <a target="_blank" href="/user/login" id="signup" class="find_text">로그인</a>
</form>

-->
<div class="_003">
    <form action="/user/signupsave" method="post" oninput="return validateForm()">
        <div class="full">
            <div class="div">개인정보 보호 동의서</div>
            <div class="div2">

            </div>
            {{#duplication}}
                <div class="duplication-danger" role="alert" style="color: #ff0000;">
                    이미 존재하는 ID 입니다.
                </div>
            {{/duplication}}
            <div class="id">
                ID<input type="text" class="form-control-id" id="LoginId" name="loginId" maxlength='30' required>

                <div id="idError" class="text-danger" style="font-size: 1vw; display: none;">아이디는 6-12자의 영문, 숫자, 기호(-, _)만 사용 가능합니다.</div>
            </div>

            <div class="div3">
                비밀번호<input type="password" class="form-control-pw" id="password" name="password" maxlength='30' required>
                <div id="passwordError" class="text-danger" style="font-size: 1vw; display: none;">비밀번호는 6-15자의 영문, 숫자, 특수문자가 하나 이상 필요합니다.</div>
            </div>

            <div class="div4">
                비밀번호 확인<input type="password" class="form-control-pwcheck" id="samepassword" name="samepassword" maxlength='30' required>
                <div id="SamepasswordError" class="text-danger" style="font-size: 1vw; display: none;">비밀번호가 일치 하지 않습니다</div>
            </div>


            <div class="div8">
                이름<input type="text" class="form-control-name" id="name" name="name" maxlength='30' required>
                <div id="nameError" class="text-danger" style="font-size: 1vw;  display: none;">이름은 한글 또는 영어로만 입력 가능합니다.</div>
            </div>
            <div class="div9">
                전화 번호<input type="tel" class="form-control-pnumber" id="phoneNumber" name="phoneNumber" maxlength='11' required>
                <div id="phoneError" class="text-danger" style="font-size: 1vw; display: none;">전화번호는 숫자만 입력 가능합니다.</div>
            </div>
            {{#not_exist_teacherCode}}
                <div class="teacnercode-danger" role="alert">
                    존재하지 않는 학급코드입니다.
                </div>
            {{/not_exist_teacherCode}}
            <div class="t-code">
                학급코드<input type="text" class="form-control-tcode" id="teacherCode" name="teacherCode" maxlength='5' placeholder="5자리" required>
            </div>

            <div class="frame-12">
                <img class="polygon-2" src="/css/images/polygon-20.svg" />
                <img class="_3" src="/images/_30.png" />
                <div class="div12">학생 회원가입</div>
            </div>
            <div class="rectangle-1062">개인정보 어쩌구 저쩌구</div>
            <input type="hidden" id="role" name="role" value="student">

        </div>
        <button type="submit" id="submitButton" class="signup-btn" disabled>회원가입</button>
    </form>
    <div class="tcode-text" id="tcode-response"></div>
    <button type="button" id="backtologin-btn" class="back-btn">
        <a target="_self" id="btlogin" class="btlogin"  href="/user/login"><< 로그인으로 돌아가기</a>
    </button>
    <button type="button" id="tcode-btn" onclick="sendtcode()" class="tcode-btn">등록하기</button>
    <img class="line-31" src="/images/line-31.svg" />
    <div class="main-box"></div>
    <div class="line1"></div>

</div>


<script>
    let isTcodeClicked = false; // tcode-btn이 클릭되었는지 여부를 저장하는 플래그

    async function sendtcode() { // 학급코드 유효성 찾기
        const tcode_input = document.getElementById("teacherCode");

        const tcode = tcode_input.value.trim(); // 공백 제거

        // 입력값이 비어있을 경우
        if (!tcode) {
            document.getElementById("tcode-response").textContent = "학급코드를 입력하세요.";
            return; // 함수 종료
        }

        try {
            const response = await fetch("/user/tcode", {
                method: "POST",
                headers: {
                    "Content-Type": "text/plain",
                },
                body: tcode
            });

            if (response.ok) {
                const data = await response.text(); // 서버에서 문자열 응답 받기
                document.getElementById("tcode-response").textContent = `${data}`;

                if (data === "등록 실패") {
                    document.getElementById("submitButton").disabled = true; // 제출 버튼 비활성화
                    isTcodeClicked = false; // 실패 시 플래그를 false로 유지
                    return false;
                } else {
                    isTcodeClicked = true; // 성공 시 플래그 true로 설정
                    validateForm(); // 입력값 다시 확인
                }
            } else {
                document.getElementById("tcode-response").textContent = "Error: Failed to send data.";
            }
        } catch (error) {
            console.error("Error:", error);
            document.getElementById("tcode-response").textContent = "Error: Unable to connect to the server.";
        }
    }

    function validateForm() { // 회원가입 입력값 유효성 검사
        let isValid = true;

        // 아이디 유효성
        const id = document.getElementById("LoginId").value;
        const idregex = /^(?![0-9]{6,12}$)[a-zA-Z0-9-_]{6,14}$/; // 6-14자 영문, 숫자, 기호(-, _)만 허용
        const iderrorMessage = document.getElementById("idError");

        if (!idregex.test(id)) {
            iderrorMessage.style.display = "block";
            isValid = false;
        } else {
            iderrorMessage.style.display = "none";
        }

        // 비밀번호 유효성
        const password = document.getElementById("password").value;
        const passwordregex = /^(?!\d)(?=[a-zA-Z0-9~․!@#$%^&*()_\-+=\[\]{}|\\;:'"<>,.?/]*[~․!@#$%^&*()_\-+=\[\]{}|\\;:'"<>,.?/])[a-zA-Z0-9~․!@#$%^&*()_\-+=\[\]{}|\\;:'"<>,.?/]{6,15}$/;
        const passworderrorMessage = document.getElementById("passwordError");

        if (!passwordregex.test(password)) {
            passworderrorMessage.style.display = "block";
            isValid = false;
        } else {
            passworderrorMessage.style.display = "none";
        }

        // 비밀번호 확인
        const samepassword = document.getElementById("samepassword").value;
        const SamepassworderrorMessage = document.getElementById("SamepasswordError");

        if (password !== samepassword) {
            SamepassworderrorMessage.style.display = "block";
            isValid = false;
        } else {
            SamepassworderrorMessage.style.display = "none";
        }

        // 이름 유효성
        const name = document.getElementById("name").value;
        const nameregex = /^[a-zA-Z]+$|^[가-힣]+$/; // 한글 또는 영어만 허용
        const nameerrorMessage = document.getElementById("nameError");

        if (!nameregex.test(name)) {
            nameerrorMessage.style.display = "block";
            isValid = false;
        } else {
            nameerrorMessage.style.display = "none";
        }

        // 전화번호 유효성
        const phone = document.getElementById("phoneNumber").value;
        const phoneregex = /^\d*$/; // 숫자만 허용
        const phoneerrorMessage = document.getElementById("phoneError");

        if (!phoneregex.test(phone)) {
            phoneerrorMessage.style.display = "block";
            isValid = false;
        } else {
            phoneerrorMessage.style.display = "none";
        }

        // 학급코드 확인
        const tcode_response = document.getElementById("tcode-response").textContent;

        if (tcode_response === "" || !isTcodeClicked) {
            isValid = false;
        }

        // 모든 조건을 통과해야 제출 버튼 활성화
        document.getElementById("submitButton").disabled = !isValid;
        return isValid;
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>