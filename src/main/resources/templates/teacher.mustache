{{>header}}


<link rel="stylesheet" href="/css/teacher.css">
<div id="back_ground">
    <main class="main-container">
        <div class="popup" id="popup">
            <div style="background-color:#576096; width: 100%; height: 10%; color: white; font-family: Hakgyo; font-size: 25px; display: flex; align-items: center; padding: 10px;">
                ìˆ˜ì—… ì¶”ê°€
            </div>
            <div style="display: flex; justify-content: center; width: 100%;">
                <form method="POST" action="/teacher/classAdd" style="padding: 10px; width: 80%; font-family: Score5; font-size: 20px;">
                    <label for="grade">í•™ë…„</label>
                    <select id="grade" name="grade" style="background-color: #FFFEFD;
                    opacity: 0.9;
                    border: 1px solid #ddd;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    width: 100%;
                    margin-bottom: 10px;
                    border-radius: 5px;
                    font-family: 'Score5', sans-serif;">
                        <option value="1">1 í•™ë…„</option>
                        <option value="2">2 í•™ë…„</option>
                        <option value="3">3 í•™ë…„</option>
                    </select>

                    <label for="class">ë¶„ë°˜</label>
                    <input id="class" maxlength="10" name="class" style="width: 100%;
                   border: 1px solid #ddd;
                   box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                   margin-bottom: 10px;
                   border-radius: 5px;
                   font-family: 'Score5', sans-serif;"
                           placeholder="ë¶„ë°˜ ì¶”ê°€"
                    />

                    <label for="subject">ê³¼ëª©</label>
                    <input id="subject" maxlength="20" name="subject" style="width: 100%;
                   border: 1px solid #ddd;
                   box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                   margin-bottom: 10px;
                   border-radius: 5px;
                   font-family: 'Score5', sans-serif;"
                           placeholder="ê³¼ëª© ì¶”ê°€"
                    />

                    <div style="display: flex; align-items: center; justify-content: flex-end; margin-top: 15px; margin-bottom: 15px;">
                        <button type="button" id="closePopup" class="btnAll">ì·¨ì†Œ</button>
                        <button type="submit" class="btnAll" style="margin-left: 15px;">ì¶”ê°€</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="popup" id="updatePopup" style="display: none;">
            <div style="background-color:#576096; width: 100%; height: 10%; color: white; font-family: Hakgyo; font-size: 25px; display: flex; align-items: center; padding: 10px;">
                ìˆ˜ì—… ìˆ˜ì •
            </div>
            <div style="display: flex; justify-content: center; width: 100%;">
                <form method="POST" action="/teacher/classUpdate" style="padding: 10px; width: 80%; font-family: Score5; font-size: 20px;">
                    <label for="class">ìˆ˜ì—…ì½”ë“œ</label>
                    <p id="updateCodeTitle"  style="width: 100%; border: 1px solid #ddd; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 10px; border-radius: 5px; font-family: 'Score5', sans-serif;"></p>
                    <input id = "updateCode" type="hidden" name="updateCode"/>
                    <label for="grade">í•™ë…„</label>
                    <select id="updateGrade" name="updateGrade" style="background-color: #FFFEFD; opacity: 0.9; border: 1px solid #ddd; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 100%; margin-bottom: 10px; border-radius: 5px; font-family: 'Score5', sans-serif;">
                        <option value="1">1 í•™ë…„</option>
                        <option value="2">2 í•™ë…„</option>
                        <option value="3">3 í•™ë…„</option>
                    </select>

                    <label for="class">ë¶„ë°˜</label>
                    <input id="updateClass" name="updateClass" style="width: 100%; border: 1px solid #ddd; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 10px; border-radius: 5px; font-family: 'Score5', sans-serif;" placeholder="ë¶„ë°˜ ìˆ˜ì •" />

                    <label for="subject">ê³¼ëª©</label>
                    <input id="updateSubject" name="updateSubject" style="width: 100%; border: 1px solid #ddd; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 10px; border-radius: 5px; font-family: 'Score5', sans-serif;" placeholder="ê³¼ëª© ìˆ˜ì •" />

                    <div style="display: flex; align-items: center; justify-content: flex-end; margin-top: 15px; margin-bottom: 15px;">
                        <button type="button" id="updateClosePopup" class="btnAll" onclick="updateClose()">ì·¨ì†Œ</button>
                        <button type="submit" class="btnAll" style="margin-left: 15px;">ìˆ˜ì •</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="popup" id="studentPopup" style="display: none;">
            <div style="background-color:#576096; width: 100%; height: 10%; color: white; font-family: Hakgyo; font-size: 25px; display: flex; align-items: center; padding: 10px;">
                í•™ìƒ ê´€ë¦¬
            </div>
            <div style="display: flex; justify-content: center; width: 100%;">
                <form method="POST" action="/teacher/studentDel" id="studentForm" style="padding: 10px; width: 80%; font-family: Score5; font-size: 20px">
                    <ul id="studentList" style="list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #ccc; border-radius: 5px;">
                        {{#student}}
                            <li style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #ddd;">
                                <span>{{name}}</span>
                                <button type="button" onclick="deleteStudent({{id}}, '{{name}}')" style="background: red; color: white; border: none; padding: 3px 6px; cursor: pointer; border-radius: 10%; font-size: 12px; line-height: 1; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">
                                    âœ•</button>
                            </li>
                        {{/student}}
                    </ul>

                    <div style="display: flex; align-items: center; justify-content: flex-end; margin-top: 15px; margin-bottom: 15px;">
                        <button type="button" id="updateClosePopup" class="btnAll" onclick="studentClose()">ì·¨ì†Œ</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="popup" id="deletePopup" style="display: none;">
            <div style="display: flex; justify-content: center; width: 100%;">
                <form method="POST" action="/teacher/classDelete" style="padding: 10px; width: 80%; font-family: Score5; font-size: 20px">
                    <label for="class">ë“±ë¡ëœ ìˆ˜ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</label>
                    <label for="class">í•´ë‹¹ ìˆ˜ì—…ê³¼ ê´€ë ¨ëœ ëª¨ë“  ê²Œì‹œë¬¼ì´ ì‚­ì œë©ë‹ˆë‹¤.</label>
                    <input id = "deleteCode" type="hidden" name="deleteCode"/>

                    <div style="display: flex; align-items: center; justify-content: flex-end; margin-top: 15px; margin-bottom: 15px;">
                        <button type="button" id="deleteClosePopup" class="btnAll" onclick="deleteClose()">ì·¨ì†Œ</button>
                        <button type="submit" class="btnAll" style="margin-left: 15px;background: #EB6319">ì‚­ì œ</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="popup" id="classManagePopup" style="display: none;">
            <div style="background-color:#576096; width: 100%; height: 10%; color: white; font-family: Hakgyo; font-size: 25px; display: flex; align-items: center; padding: 10px;">
                í•™ê¸‰ ì •ë³´ ê´€ë¦¬
            </div>
            <div style="display: flex; justify-content: center; width: 100%; padding-top: 20px;">
                <form method="POST" action="/teacher/classManage" id="updateClass" style="padding: 20px; width: 80%;">

                    <input type="hidden" name="id" value="{{member.id}}">

                    <!-- ì´ë¦„ ì…ë ¥ í•„ë“œ (ê¸°ì¡´ ë°ì´í„° ë¯¸ë¦¬ ì…ë ¥) -->
                    <div style="margin-bottom: 15px;">
                        <label for="name" style="font-size: 18px;">í•™êµ:</label>
                        <input type="text" id="school" name="school" value="{{member.school}}" required
                               style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ccc; border-radius: 8px; text-align: center; outline: none;">
                    </div>

                    <!-- í•™ë…„ ì…ë ¥ í•„ë“œ (ê¸°ì¡´ ë°ì´í„° ë¯¸ë¦¬ ì…ë ¥) -->
                    <div style="margin-bottom: 15px;">
                        <label for="schoolGrade" style="font-size: 18px;">í•™ë…„:</label>
                        <input type="number" min="1" max="3" id="schoolgrade" name="schoolgrade" value="{{member.schoolgrade}}" required
                               style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ccc; border-radius: 8px; text-align: center; outline: none;">
                    </div>

                    <!-- ë°˜ ì…ë ¥ í•„ë“œ (ê¸°ì¡´ ë°ì´í„° ë¯¸ë¦¬ ì…ë ¥) -->
                    <div style="margin-bottom: 15px;">
                        <label for="schoolClass" style="font-size: 18px;">ë°˜:</label>
                        <input type="number" min="1" id="schoolClass" name="schoolClass" value="{{member.schoolClass}}" required
                               style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ccc; border-radius: 8px; text-align: center; outline: none;">
                    </div>

                    <!-- ìˆ˜ì • ë²„íŠ¼ -->
                    <div style="display: flex; align-items: center; justify-content: flex-end; margin-top: 15px; margin-bottom: 15px;">
                        <button type="button" id="deleteClosePopup" class="btnAll" onclick="classManageClose()">ì·¨ì†Œ</button>
                        <button type="submit" class="btnAll" style="margin-left: 15px;background: #EB6319">ë³€ê²½</button>
                    </div>
                </form>
            </div>
        </div>


        <div class="class-info">
            <p style="font-family: Score5; font-size: 30px; color: black;">ë‹´ì„ í•™ê¸‰</p>
            <div class="circle">{{member.schoolgrade}}í•™ë…„ {{member.schoolClass}}ë°˜<br>{{member.teacherCode}}
            </div>
            <div class="text-button-container">
                <span style="

                font-family: Score5; font-size: 20px; color: black" class="text">ìˆ˜ì—… ëª©ë¡</span>
                <div class="plus" id="openPopup"></div>
            </div>
            <div style="width: 100%; min-height: 50px; max-height: 500px; border-radius: 15px; background-color: #F6E1A0; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); overflow-y: auto; padding: 10px;">
                {{#subjects}}
                    <div class="text-button-container">
                        <div id = "backDiv" class="item" style="margin-bottom: 10px;width: 100%; background-color: white; border-radius: 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 10px;cursor: pointer;" onclick="toggleButtons(this)">
                            <p style="font-family: Score5; text-align: center;">[{{subject}}] {{grade}}í•™ë…„ {{divClass}}ë¶„ë°˜</p><br>
                            <p id = "classCode" style="font-family: Score5; text-align: center;">ìˆ˜ì—… ì½”ë“œ : {{id}}</p>
                            <div class="hidden-buttons" style="display: none; justify-content: center; margin-top: 10px; gap: 10px;">
                                <button class="edit-btn"  onclick="update(this)" style="font-family: Score6;background-color: #F19B2A;box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); color: white; padding: 5px 10px; border-radius: 15px; border: none; cursor: pointer;">ìˆ˜ì •</button>
                                <button class="delete-btn" onclick="deleteClass(this)" style="font-family: Score6;background-color: #E55D5D;box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); color: white; padding: 5px 10px; border-radius: 15px; border: none; cursor: pointer;">ì‚­ì œ</button>
                            </div>
                        </div>
                    </div>
                {{/subjects}}
                {{^subjects}}
                    <div class="text-button-container">
                            <p style="font-family: Score5; text-align: center;">ìˆ˜ì—…ì„ ë“±ë¡í•´ ì£¼ì„¸ìš”!</p>
                    </div>
                {{/subjects}}
            </div>
        </div>

        <div class="grid">
            <!-- í•™ìƒ ìƒë‹´ -->
            <div class="card">
                <h2 style="font-family:Hakgyo ">í•™ìƒ ìƒë‹´</h2>
                <ul class="cardIn" style="padding: 5%">
                    <li onclick="location.href='/counsel/Audio'" style="cursor:pointer;">ìŒì„± ìƒë‹´ ë¶„ì„</li>
                    <li onclick="location.href='/teacher/student_recode'" style="cursor:pointer;">ìƒë‹´ ê¸°ë¡</li>
                    <li onclick="location.href='/teacher/student_recode'" style="cursor:pointer;">í•™ìƒ ìƒí™œê¸°ë¡ë¶€ ë“±ë¡</li>
                </ul>
            </div>

            <!-- ì‹œí—˜ ê²°ê³¼ í™•ì¸ -->
            <div class="card">
                <h2 style="font-family:Hakgyo ">ì‹œí—˜ ê²°ê³¼ í™•ì¸</h2>
                <ul class="cardIn" style="padding: 5%">
                    <li style="background-color: transparent; box-shadow: none;"></li>
                    {{#firstSubject}}
                    <li onclick="location.href='/testResult/list?id={{firstSubject.id}}'" style="cursor:pointer;">ê³¼ëª©ë³„ ì‹œí—˜ ê²°ê³¼ í™•ì¸</li>
                    {{/firstSubject}}
                    <li style="background-color: transparent; box-shadow: none;"></li>
                </ul>
            </div>

            <!-- ìˆ˜ì—… ë¶„ì„ -->
            <div class="card">
                <h2 style="font-family:Hakgyo ">ìˆ˜ì—… ë¶„ì„</h2>
                <ul class="cardIn">
                    <div class="video-container">
                        <a class="play-button" onclick="checkSubjects()"></a>
                        <img src="/images/analyzeEnd.svg"/>

                    </div>
                </ul>
            </div>

            <!-- ìš°ë¦¬ ë°˜ ê´€ë¦¬ -->
            <div class="card">
                <h2 style="font-family:Hakgyo ">ìš°ë¦¬ ë°˜ ê´€ë¦¬</h2>
                <ul class="cardIn" style="padding: 5%">
                    <li onclick="studentPopup()" style="cursor:pointer;"><div>í•™ìƒ ê´€ë¦¬</div></li>
                    <li onclick="location.href='/myClass/list?id={{member.teacherCode}}'" style="cursor:pointer;">ìš°ë¦¬ë°˜ ì»¤ë®¤ë‹ˆí‹°</li>
                    <li onclick="classManagePopup()" style="cursor:pointer;"><div>í•™ê¸‰ ì •ë³´ ê´€ë¦¬</div></li>
                </ul>
            </div>
        </div>
    </main>
</div>

<script>
    var subLen = {{subLen}};
    document.getElementById('openPopup').addEventListener('click', function() {
        document.getElementById('popup').style.display = 'block';
    });

    document.getElementById('closePopup').addEventListener('click', function() {
        document.getElementById('popup').style.display = 'none';
    });


    function checkSubjects() {

        if (subLen === 0) {
            alert("ìˆ˜ì—… ëª©ë¡ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
        } else {
            window.location.href = "/teacher/class";  // URL ì´ë™
        }
    }
    function studentPopup(){
        document.getElementById('studentPopup').style.display = 'block';
    }
    function studentClose(){
        document.getElementById('studentPopup').style.display = 'none';
    }

    function classManagePopup(){
        document.getElementById('classManagePopup').style.display = 'block';
    }
    function classManageClose(){
        document.getElementById('classManagePopup').style.display = 'none';
    }

    function toggleButtons(item) {
        const hiddenButtons = item.querySelector('.hidden-buttons'); // í´ë¦­í•œ ì•„ì´í…œ ë‚´ì˜ hidden-buttons ì°¾ê¸°
        const backDiv = item; // í´ë¦­í•œ ì•„ì´í…œì„ backDivë¡œ ì‚¬ìš©

        if (hiddenButtons.style.display === 'none' || hiddenButtons.style.display === '') {
            hiddenButtons.style.display = 'flex';
            backDiv.style.backgroundColor = '#B0B7E2';  // í´ë¦­í•œ ì•„ì´í…œ ë°°ê²½ìƒ‰ ë³€ê²½
        } else {
            hiddenButtons.style.display = 'none';
            backDiv.style.backgroundColor = '#ffffff';  // ë‹¤ì‹œ ë°°ê²½ìƒ‰ ì›ë˜ëŒ€ë¡œ
        }
    }

    function update(element) {
        // í´ë¦­ëœ ì•„ì´í…œì—ì„œ ê°’ ì¶”ì¶œ
        var item = element.closest('.item');  // í´ë¦­ëœ itemì„ ì°¾ì•„ì„œ
        var textContent = item.querySelector('p').innerText;
        var classCodeText = item.querySelector('#classCode').innerText;  // í•´ë‹¹ ì•„ì´í…œ ë‚´ì˜ classCodeë¥¼ ì°¸ì¡°
        var classCode = classCodeText.split(":")[1].trim();
        var subject = textContent.match(/\[([^\]]+)\]/)[1]; // [ë¬¼ë¦¬]ì—ì„œ ë¬¼ë¦¬ ì¶”ì¶œ
        var grade = textContent.match(/(\d+)í•™ë…„/)[1]; // 1í•™ë…„ì—ì„œ 1 ì¶”ì¶œ
        var divClass = textContent.match(/(\w+)ë¶„ë°˜/)[1];

        console.log(classCode);
        console.log(subject);
        console.log(grade);
        console.log(divClass);
        // íŒì—…ì˜ ì…ë ¥ í•„ë“œì— ë””í´íŠ¸ ê°’ ì„¤ì •
        document.getElementById('updateCodeTitle').textContent = classCode;
        document.getElementById('updateCode').value = classCode;
        document.getElementById('updateGrade').value = grade;
        document.getElementById('updateClass').value = divClass;
        document.getElementById('updateSubject').value = subject;

        // íŒì—… í‘œì‹œ
        document.getElementById('updatePopup').style.display = 'block';
    }

    function updateClose(){
        document.getElementById('updatePopup').style.display = 'none';
    }

    function deleteClass(element) {
        // í´ë¦­ëœ ì•„ì´í…œì—ì„œ ê°’ ì¶”ì¶œ
        var item = element.closest('.item');  // í´ë¦­ëœ itemì„ ì°¾ì•„ì„œ
        var classCodeText = item.querySelector('#classCode').innerText;  // í•´ë‹¹ ì•„ì´í…œ ë‚´ì˜ classCodeë¥¼ ì°¸ì¡°
        var classCode = classCodeText.split(":")[1].trim();  // ìˆ˜ì—… ì½”ë“œë¥¼ ì¶”ì¶œ

        // íŒì—…ì˜ ì…ë ¥ í•„ë“œì— ë””í´íŠ¸ ê°’ ì„¤ì •
        document.getElementById('deleteCode').value = classCode;

        // íŒì—… í‘œì‹œ
        document.getElementById('deletePopup').style.display = 'block';
    }

    function deleteClose(){
        document.getElementById('deletePopup').style.display = 'none';
    }


    function deleteStudent(studentId, studentName) {
        const confirmed = confirm(`ğŸš¨[ì£¼ì˜]\n${studentName} í•™ìƒì„ ë°˜ì—ì„œ ì œì™¸í•˜ê² ìŠµë‹ˆê¹Œ? \ní•™ìƒì˜ ìˆ˜ê°• ëª©ë¡ì´ ì´ˆê¸°í™” ë©ë‹ˆë‹¤.`);
        if (confirmed) {
            const form = document.getElementById("studentForm");
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "studentId";
            input.value = studentId;
            form.appendChild(input);
            form.submit();
        }
    }


    document.getElementById("updateClass").addEventListener("submit", async function(event) {
        event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë°©ì§€
        if (!confirm("í•™ê¸‰ ì •ë³´ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            console.log("ì‚¬ìš©ìê°€ ì·¨ì†Œí•¨");
            return; // ì‚¬ìš©ìê°€ ì·¨ì†Œ(Cancel)ë¥¼ ëˆ„ë¥´ë©´ ìš”ì²­ì„ ë³´ë‚´ì§€ ì•ŠìŒ
        }

        const formData = new FormData(this);

        try {
            const response = await fetch(this.action, {
                method: "POST",
                body: formData
            });

            if (!response.ok) {
                throw new Error("ë°˜ ì½”ë“œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");ã„¹
            }

            const result = await response.json();

            alert(result.message);
            window.location.href = "/teacher"; // ë³€ê²½ ì™„ë£Œ í›„ í˜ì´ì§€ ì´ë™

        } catch (error) {
            alert(error.message || "ì„œë²„ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    });
</script>
{{>footer}}